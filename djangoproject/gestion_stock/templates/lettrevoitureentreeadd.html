{% extends user.is_authenticated|yesno:"base_generic.html,empty.html" %}

{% block content %}
<html>

<style>
    .ui-dialog-titlebar-close {
        visibility: hidden;
    }
    input.text { margin-bottom:12px; width:95%; padding: .4em; }
    fieldset { padding:0; border:0; margin-top:25px; }
    .ui-dialog .ui-state-error { padding: .3em; }
    .validateTips { border: 1px solid transparent; padding: 0.3em;}
</style>

<div class="container"><h1 class="text-center"> Ajout de L.V entree</h1></div>
<br>

<div class="container">
    <div class="form-group row text-center">
        <div class="col">
            <button type="button" id="back-row" class="btn btn-default btn-rounded btn-outline-dark">Tout</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-3 mx-auto">
            <div class="border shadow-lg p-2 mb-3 bg-white rounded">
                <div class="col">
                    <h5 class="text-center"> <u> fichiers </u></h5>
                    <div class="container">
                        <div class="row">
                            <div class="mx-auto">
                                <p style="cursor: pointer;">fichier <i class="fas fa-file"></i></p>
                                <p>photo <i class="far fa-image"></i></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="border shadow-lg p-2 mb-3 bg-white rounded">
                <div class="row">
                    <div class="col">
                        <h3 class="text-center"> Identification LDV</h3>
                    </div>
                </div>
                <br>
                <div class="container">
                    <div class="row">
                        <div class="text-center">
                            <div class="row">
                                <div class="col">
                                    <label for="umid">identifiant:</label>
                                    <br><input type="text" id="umid" disabled class="form-control">
                                </div>
                                <div class="col">
                                    <label for="inputMDEx">date de réception:</label>
                                    <input type="date" id="inputMDEx" class="form-control">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col">numéro récépissé:<br><input type="text" id="numr" class="form-control">
                                </div>
                                <div class="col">
                                    <label for="qpal">quantité palette:</label>
                                    <br><input type="text" id="qpal" class="form-control">
                                </div>
                                <div class="container">
                                    <div class="row">
                                        <div class="col">
                                            <div class="row">
                                                <div class="col-1">
                                                    <button id="accesslve" style="width: 50%; height: 30px;" class="rounded mt-4"><i style="font-size: 50%" class="fas fa-arrow-right"></i></button>
                                                </div>
                                                <div class="col">
                                                    <div class="selsel">
                                                        <label for="transporteur">transporteur:</label>
                                                        <select class="form-control" id="transporteur">
                                                            <script type="text/javascript">
                                                                $(document).ready(function() {
                                                                    var i = 0;
                                                                    "{% for items in trans %}"
                                                                    console.log("transporteur");
                                                                    //to change
                                                                    var name = "{{ items.nom|escapejs }}";
                                                                    var oldname;
                                                                    if (i == 0)
                                                                        $("#transporteur").append(new Option("{{ items.nom|escapejs }}", "{{ items.nom|escapejs }}"));
                                                                    else if (name != oldname)
                                                                        $("#transporteur").append(new Option("{{ items.nom|escapejs }}", "{{ items.nom|escapejs }}"));
                                                                    oldname = name;
                                                                    i = 1;
                                                                    "{% endfor %}"
                                                                });
                                                            </script>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <label for="inputqc">quantité colis :</label>
                                            <input id="inputqc" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <br>
                                <div class="row">
                                    <div class="col">
                                        <input type="button" class="btn btn-primary btn-sm ml-3" id="addlve" value="Save">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col">
            <div class="border shadow-lg p-2 mb-3 bg-white rounded">
                <h5 class="text-center"> <u> Bons de livraison </u></h5>
                <div class="container">
                    <div class="table-responsive">
                        <table id="tabbl" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th scope="col" class="th-sm text-center"><i class="fas fa-cog"></i></th>
                                <th scope="col" class="th-sm text-center"> client </th>
                                <th scope="col" class="th-sm text-center"> date réception </th>
                                <th scope="col" class="th-sm text-center"> n° BL </th>
                                <th scope="col" class="th-sm text-center"> qte palettes </th>
                                <th scope="col" class="th-sm text-center"> <i class="fa fa-trash"></i> </th>
                            </tr>
                            </thead>
                            <tbody id="tabblbody">
                            {% for items in entree %}
                            <!--<tr>
                                <td> <button id='{{ items.idBonLivraisonEntree }}' class="dyna"> -> </button></td>
                                <td> {{ items.fk_TypeZoneDepot.nom }} </td>
                                <td> {{ items.dateReception }} </td>
                                <td> {{ items.numeroBonLivraison }} </td>
                                <td> <button id='{{ items.idBonLivraisonEntree  }}' class="dynad"> X </button> </td>
                            </tr>-->
                            {% endfor %}
                            </tbody>
                        </table>
                        <button class="btn btn-blue btn-sm" id="addlignebl"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-5">
            <div class="border shadow-lg p-2 mb-3 bg-white rounded">
                <div class="row">
                    <div class="col">
                        <h5 class="text-center"> <u> Réclamation </u></h5>
                        <br>
                        Quantité colis :<br><input type="text" id="qcrecla" class="form-control">
                        Quantité palettes :<br><input type="text" id="qprecla" class="form-control">
                        commentaire :<br><input type="text" id="comrecla"  class="form-control" style="height: 100px;">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-7">
            <div class="border shadow-lg p-2 mb-3 bg-white rounded">
                <h5 class="text-center"> <u>  Ordre de transport </u></h5>
                <div class="container">
                    <div class="table-responsive">
                        <table id="tabbcm" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                            <thead>
                            <tr>
                                <th scope="col" class="th-sm"><i class="fas fa-cog"></i></th>
                                <th scope="col" class="th-sm"> id </th>
                                <th scope="col" class="th-sm"> date </th>
                                <th scope="col" class="th-sm"> <i class="fa fa-trash"></i> </th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for items in entree %}
                            <!--<tr>
                                <td> <button id='{{ items.idBonLivraisonEntree }}' class="dyna"> -> </button></td>
                                <td> {{ items.fk_TypeZoneDepot.nom }} </td>
                                <td> {{ items.dateReception }} </td>
                                <td> {{ items.numeroBonLivraison }} </td>
                                <td> <button id='{{ items.idBonLivraisonEntree  }}' class="dynad"> X </button> </td>
                            </tr>-->
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="dialog-confirm" title="Ajouter des lignes">
    Combien de lignes faut-il ajouter ?</p>
    <p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>
        <input id="numberligne" type="text" pattern="[0-9]+">
</div>
<br>
<br>
<script>
    var upperid = "0";
    "{% for items in lve %}"
    if (parseInt(upperid, 10) < parseInt('{{ items.idLettreVoitureEntree }}', 10)) {
        upperid = parseInt('{{ items.idLettreVoitureEntree }}', 10);
    }
    "{% endfor %}"
    if (upperid == 0)
        $("#umid").val(1);
    else
        $("#umid").val(upperid+1);

    $(document).ready(function() {
        $("#back-row").click( function() {
            location.href = "{% url 'lve' %}";
        });

        $('#addlve').click(function() {
            $.ajax({
                type:"POST",    //type de requête utilisé par ajax
                url:"/lve/create/", //lien de la view qui gère la requête post
                data: {
                    'id': $('#umid').val(),
                    'dater': $('#inputMDEx').val(),
                    'numr': $('#numr').val(),
                    'qpalette': $('#qpal').val(),
                    'transp': $('#transporteur').val(),
                    'qcolis': $('#inputqc').val(),
                    'quantitecolrecla': $('#qcrecla').val(),
                    'quantitepalrecla': $('#qprecla').val(),
                    'comrecla': $('#comrecla').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function(msg, data, settings){
                    console.log("success: " + msg);
                },
                failure: function() {
                    alert("fail");
                }
            });
        });

        $('#addlignebl').click(function() {
            $("#dialog-confirm").dialog("open");
        });
        var nbrligne = 0;
        $("#dialog-confirm").dialog({
            resizable: false,
            height: "auto",
            width: 400,
            modal: true,
            buttons: {
                "Annuler": function() {
                    $('#numberligne').val("");
                    $(this).dialog("close");
                },
                ok: function() {
                    nbrligne = $('#numberligne').val();
                    $('#numberligne').val("");
                    $(this).dialog("close");
                    for (var nbr = nbrligne; nbr > 0; nbr--) {
                        $('#tabblbody').append("<tr><td class='text-center'><button class='resetb' id=\"reset" + nbr + "\"><i class=\"fas fa-arrow-right\"></i></button></td>" +
                            "<td class='text-center'><input disabled class='form-control'></td>" +
                            "<td><input disabled class='form-control'></td>" +
                            "<td><input disabled class='form-control'></td>" +
                            "<td><input disabled class='form-control'></td>" +
                            "<td class='text-center'><button class='resetb btn btn-light btn-sm' id=\"reset" + nbr + "\"><i class=\"fas fa-trash-alt\"></i></button></td>");
                        '{% for items in art %}'
                        $("select.fournise:last").append(new Option("{{ items.codeFournisseur }}", "{{ items.codeFournisseur }}"));
                        $("select.desif:last").append(new Option("{{ items.designationClient }}", "{{ items.designationClient }}"));
                        $("select.fournise:last").val("");
                        $("select.desif:last").val("");
                        '{% endfor %}'
                    }
                    //code fournisseur
                    for (var a = nbrligne; a != 0; a--) {
                        $("#blfournisseur" + a).combobox();
                    }
                    $("#toggle").on("click", function () {
                        for (var a = nbrligne; a != 0; a--) {
                            $("#blfournisseur" + a).toggle();
                        }
                    });
                    for (var a = nbrligne; a != 0; a--) {
                        $("#iddesif" + a).combobox();
                    }
                    $("#toggle").on("click", function () {
                        for (var a = nbrligne; a != 0; a--) {
                            $("#iddesif" + a).toggle();
                        }
                    });

                    $(".fournise").combobox({
                        select: function (event, ui) {
                            '{% for items in art %}'
                            if ('{{ items.codeFournisseur }}' == this.value) {
                                console.log("therae");
                                //$(this).closest('td').next().find('select').val('{{ items.designationClient }}');
                                //$(this).closest('td').next().find('select').find('option').remove();
                                $(this).closest('td').next().find('select').find('option').remove();
                                $(this).closest('td').next().find('select').append(new Option("{{ items.designationClient }}", "{{ items.designationClient }}"));
                            }
                            '{% endfor %}'
                        }
                    });
                    $(".desif").combobox({
                        select: function (event, ui) {
                            '{% for items in art %}'
                            if ('{{ items.designationClient  }}' == this.value) {
                                console.log("therae");
                                //$(this).closest('td').next().find('select').val('{{ items.designationClient }}');
                                //$(this).closest('td').next().find('select').find('option').remove();
                                $(this).closest('td').prev().find('select').find('option').remove();
                                $(this).closest('td').prev().find('select').append(new Option("{{ items.codeFournisseur }}", "{{ items.codeFournisseur }}"));
                            }
                            '{% endfor %}'
                        }
                    });
                    $('.resetb').click(function () {
                        //alert("gg " + $(this).attr('id'));
                        //var id = $(this).attr('id');
                        $(this).closest('td').parent().find('td').eq(0).next().find('select').find('option').remove();
                        $(this).closest('td').parent().find('td').eq(1).next().find('select').find('option').remove();
                        '{% for items in art %}'
                        $(this).closest('td').parent().find('td').eq(0).next().find('select').append(new Option("{{ items.codeFournisseur }}", "{{ items.codeFournisseur }}"));
                        $(this).closest('td').parent().find('td').eq(1).next().find('select').append(new Option("{{ items.designationClient }}", "{{ items.designationClient }}"));
                        '{% endfor %}'
                    });
                }
            },
        });

        $("#dialog-confirm").dialog("close");
        $('body').on('click', '.butctrl', function() {
            if ($(this).hasClass("btn-light")) {
                $(this).removeClass("btn-light");
                $(this).addClass("btn-success");
                $(this).find($("i")).removeClass('fa-thumbs-down').addClass('fa-thumbs-up');
            }
            else
            {
                $(this).removeClass("btn-success");
                $(this).addClass("btn-light");
                $(this).find($("i")).removeClass('fa-thumbs-up').addClass('fa-thumbs-down');
            }
        });

        $(document).on("input", "input", function (event) {
            if (this.checkValidity()) {
                $(this).data('last-valid', this.value);
            }
            else {
                var myvalue = $(this).text();
                if($.isNumeric($('#numberligne').val())) {
                    console.log("numeric");
                } else {
                    console.log("not numeric");
                    $('#numberligne').popover({
                        trigger: 'manual',
                        title: 'Warning!',
                        content: 'Value can not be empty',
                        placement: 'left',
                    }).popover('show');
                    setTimeout(closederror, 2000);
                }
                this.value = $(this).data('last-valid') || "";
            }
        });

        function checkligne() {
            $("#numberligne").popover({trigger: 'manual', content: "Input only numbers!", placement : 'right'});
            $("#numberligne").popover('show');
        };
        function closederror() {
            $("#numberligne").popover('dispose');
        };

        $.widget( "custom.combobox", {
            _create: function() {
                this.wrapper = $( "<span>" )
                    .addClass( "custom-combobox" )
                    .insertAfter( this.element );

                this.element.hide();
                this._createAutocomplete();
                this._createShowAllButton();
            },
            _createAutocomplete: function() {
                var selected = this.element.children( ":selected" ),
                    value = selected.val() ? selected.text() : "";

                this.input = $("<input>")
                    .appendTo( this.wrapper)
                    .val(value)
                    .attr("title", "")
                    .addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left")
                    .autocomplete({
                        delay: 0,
                        minLength: 0,
                        source: $.proxy(this, "_source")
                    })
                    .tooltip({
                        classes: {
                            "ui-tooltip": "ui-state-highlight"
                        }
                    });
                this._on( this.input, {
                    autocompleteselect: function(event, ui) {
                        ui.item.option.selected = true;
                        this._trigger("select", event, {
                            item: ui.item.option
                        });
                    },
                    autocompletechange: "_removeIfInvalid"
                });
            },
            _createShowAllButton: function() {
                var input = this.input,
                    wasOpen = false;
                $("<a>")
                    .attr("tabIndex", -1)
                    .attr("title", "Show All Items")
                    .tooltip()
                    .appendTo(this.wrapper)
                    .button({
                        icons: {
                            primary: "ui-icon-triangle-1-s"
                        },
                        text: false
                    },)
                    .removeClass("ui-corner-all")
                    .addClass("custom-combobox-toggle ui-corner-right")
                    .on("mousedown", function() {
                        wasOpen = input.autocomplete("widget").is(":visible");
                    })
                    .on("click", function() {
                        input.trigger("focus");
                        // Close if already visible
                        if (wasOpen) {
                            return;
                        }
                        // Pass empty string as value to search for, displaying all results
                        input.autocomplete("search", "");
                    });
            },
            _source: function(request, response) {
                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                response(this.element.children("option").map(function() {
                    var text = $(this).text();
                    if (this.value && (!request.term || matcher.test(text)))
                        return {
                            label: text,
                            value: text,
                            option: this
                        };
                }) );
            },
            _removeIfInvalid: function(event, ui) {
                // Selected an item, nothing to do
                if (ui.item) {
                    return;
                }
                // Search for a match (case-insensitive)
                var value = this.input.val(),
                    valueLowerCase = value.toLowerCase(),
                    valid = false;
                this.element.children("option").each(function() {
                    if ($(this).text().toLowerCase() === valueLowerCase) {
                        this.selected = valid = true;
                        return false;
                    }
                });
                // Found a match, nothing to do
                if (valid) {
                    return;
                }
                // Remove invalid value
                this.input
                    .val("")
                    .attr("title", value + " didn't match any item")
                    .tooltip("open");
                this.element.val("");
                this._delay(function() {
                    this.input.tooltip("close").attr("title", "");
                }, 2500);
                this.input.autocomplete("instance").term = "";
            },
            _destroy: function() {
                this.wrapper.remove();
                this.element.show();
            },
        });
        $("#transporteur").val("");
        $("#transporteur").combobox();
        $("#toggle").on("click", function () {
            $("#transporteur").toggle();
        });
    });
</script>
</html>
{% endblock %}
