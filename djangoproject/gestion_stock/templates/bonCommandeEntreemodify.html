{% extends "base_generic.html" %}

{% block content %}

<style>
    .ui-dialog-titlebar-close {
        visibility: hidden;
    }
    input.text { margin-bottom:12px; width:95%; padding: .4em; }
    fieldset { padding:0; border:0; margin-top:25px; }
    .ui-dialog .ui-state-error { padding: .3em; }
    .validateTips { border: 1px solid transparent; padding: 0.3em;}
</style>

<div class="container"><h1 class="text-center"> Ajout Bon commande Entree</h1></div>
<br>

<div class="container">
    <div class="form-group row">
        <div class="col-md-2">
            <button type="button" class="btn btn-light btn-rounded btn-outline-dark">Recherche</button>
        </div>
        <div class="col-md-2">
            <button type="button" id="back-row" class="btn btn-default btn-rounded btn-outline-dark">Tout</button>
        </div>
        <div class="col-md-2">
            <button type="button" id="create-row" class="btn btn-success btn-rounded btn-outline-dark">Ajouter</button>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-default btn-rounded btn-outline-dark">Calculer</button>
        </div>
    </div>
</div>

<div class="container">

    <div class="row">
        <div class="col-md-auto">
            <div class="border shadow-lg p-3 mb-5 bg-white rounded col-md-auto">

                <div class="row">
                    <div class="col">
                        <p class="text-center"> <h4 class="text-center"> <u> Identifiant </u> </h4></p>
                    </div>
                </div>

                <br>
                <div class="row">
                    <div class="mx-auto">
                        <div class="col">
                            <div class="text-center">identifiant:</div>
                            <input type="text" id="umid" name="id_Client" disabled>
                        </div>
                    </div>
                </div>

                <br>
                <div class="row">
                    <div class="mx-auto">
                        <div class="col">
                            <div class="text-center">n° commande :</div>
                            <input type="text" id="ncommande" name="id commande">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="mx-auto">
                        <div class="col">
                            <br>
                            <div class="text-center">date commande :</div>
                            <input type="text" id="datec" name="date">
                        </div>
                    </div>
                </div>
                <br>
                <button type="button" class="btn btn-primary" id="sendclient"> ajouter </button>

            </div>
        </div>

        <div class="col">
            <div class="border shadow-lg p-3 mb-5 bg-white rounded col-md-auto">

                <div class="row">
                    <div class="col">
                        <p class="text-center"> <h4 class="text-center"> <u> Bons de livraison </u> </h4></p>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="table-responsive">
                            <table id="dtBasicExample" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                                <thead>
                                <tr>
                                    <th scope="col" class="th-sm"> modify </th>
                                    <th scope="col" class="th-sm"> n° BL </th>
                                    <th scope="col" class="th-sm"> date réception </th>
                                    <th scope="col" class="th-sm"> delete </th>
                                </tr>
                                </thead>
                                <tbody>
                                <!--
                                    {% for items in bone %}
                                    <tr>
                                        <td> <button id='{{ items.idClient }}' class="dyna"> -> </button></td>
                                        <td> {{ items.nom }} </td>
                                        <td> {{ items.nom }} </td>
                                        <td> <button id='{{ items.idClient }}' class="dynad"> X </button> </td>
                                      </tr>
                                      {% endfor %}
                                  -->
                                </tbody>
                            </table>
                        </div>
                        <button id="addlignebl" type="button" class="btn btn-success">Add</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="border shadow-lg p-3 mb-5 bg-white rounded col">

            <div class="row">
                <div class="col">
                    <p class="text-center"> <h7 class="text-center"> <u> <strong> Lignes du bon de commande entree </strong> </u> </h7></p>
                </div>
            </div>

            <div class="col">
                <div class="table-responsive">
                    <table id="dtBasicExample1" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                        <thead>
                        <tr>
                            <th scope="col" class="th-sm"> code client </th>
                            <th scope="col" class="th-sm"> code fournisseur </th>
                            <th scope="col" class="th-sm"> désignation client </th>
                            <th scope="col" class="th-sm"> désignation fournisseur </th>
                            <th scope="col" class="th-sm"> qte produits </th>
                            <th scope="col" class="th-sm"> qte colis </th>
                            <th scope="col" class="th-sm"> date livraison prévue </th>
                            <th scope="col" class="th-sm"> delete </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for items in bl %}
                        <tr>
                            <td> <button id='{{ items.idClient }}' class="dyna"> -> </button></td>
                            <td> {{ items.nom }} </td>
                            <td> <button id='{{ items.idClient }}' class="dynad"> X </button> </td>
                        </tr>
                        {% endfor %}
                        </tbody>

                    </table>
                </div>
                <button id="addligne" type="button" class="btn btn-success">Add</button>
            </div>
        </div>
    </div>

    <div id="dialog-confirm" title="Ajouter des lignes">
        Combien de lignes faut-il ajouter ?</p>
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>
            <input id="numberligne" type="text" pattern="[0-9]+">
    </div>
</div>

<script>
    $(document).ready(function() {
        console.log("my id is: " + '{{ id }}');
        $("#umid").val('{{ id }}');
        '{% for items in bone %}'
        if ('{{ items.idBonCommandeEntree }}' == '{{ id }}') {
            $("#ncommande").val('{{ items.numeroCommande }}');
            $("#datec").val('{{ items.dateCommande }}');
            //Ici Je dois récuperer tous les bl dans les bl de bcs et les lignes du bon de com venant des articles!
        }
        '{% endfor %}'
        $("#sendclient").click(function() {
            /*$
            var i = 0;
            var idx = 0;
            var contact = {};
            var nom = "";
            var prenom = "";
            var tel = "";
            var mail = "";
            var role = "";
            ('#contacttable tr').each(function (a, b) {  //recupère les contacts entrée dans la table
                if (a === 0) {
                  // Je ne prends pas en compte le "thead".
                }
                else {
                    var val = $('#contacttable').find('#'+idx).val();
                    var stock = "";
                    $(this).find('td').each (function(a, b) {
                      if (a === 0 || a === 5) {
                      } else {
                        stock = $(this).text();
                        if (a === 1) {
                          nom = stock;
                        }
                        if (a === 2) {
                          prenom = stock;
                        }
                        if (a === 3) {
                          tel = stock;
                        }
                        if (a === 4) {
                          mail = stock;
                        }
                      }
                    });
                    contact[idx] = {"role": val, "nom": nom, "prenom": prenom, "tel": tel, "mail": mail};
                    //console.log(contact);
                    role = val;
                    idx++;
                }
              });*/
            console.log("adding_t");
            $.ajax({
                type:"POST",    //type de requête utilisé par ajax
                url:"/bon_entree/modif/", //lien de la view qui gère la requête post
                data: {
                    'id': $('#umid').val(),
                    'ncommande': $('#ncommande').val(),
                    'datecom': $('#datec').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(msg, data, settings) {
                    console.log("contact " + msg);
                },
                failure: function() {
                    alert("fail");
                }
            });
        });

        $(document).on("input", "input", function (event) {
            if (this.checkValidity()) {
                $(this).data('last-valid', this.value);
            }
            else {
                var myvalue = $(this).text();
                if($.isNumeric($('#numberligne').val())) {
                    console.log("numeric");
                } else {
                    console.log("not numeric");
                    $('#numberligne').popover({
                        trigger: 'manual',
                        title: 'Warning!',
                        content: 'Value can not be empty',
                        placement: 'left',
                    }).popover('show');
                    setTimeout(closederror, 2000);
                }
                this.value = $(this).data('last-valid') || "";
            }
        });

        function checkligne() {
            $("#numberligne").popover({trigger: 'manual', content: "Input only numbers!", placement : 'right'});
            $("#numberligne").popover('show');
        };

        function closederror() {
            $("#numberligne").popover('dispose');
        };

        $("#back-row").click(function() {
            location.href = "{% url 'bonCommandeEntree' %}";
        });

        $('#dtBasicExample').DataTable();
        $('#dtBasicExample1').DataTable();
        $('.dataTables_length').addClass('bs-select');

        $('#addligne').click(function() {
            $("#dialog-confirm").dialog("open");
        });

        var nbrligne = 0
        $("#dialog-confirm").dialog({
            resizable: false,
            height: "auto",
            width: 400,
            modal: true,
            buttons: {
                "Annuler": function() {
                    $('#numberligne').val("");
                    $(this).dialog("close");
                },
                ok: function() {
                    nbrligne = $('#numberligne').val();
                    $('#numberligne').val("");
                    $(this).dialog("close");
                    for (nbrligne; nbrligne > 0; nbrligne--) {
                        //crée un nombre x de lignes a remplir
                    }
                }
            },
        });
        $("#dialog-confirm").dialog("close");
    });
</script>

{% endblock %}